<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿›ç¨‹ç®¡ç†</title>
    <link rel="stylesheet" href="common-style.css">
    <script src="bridge.js"></script>
    <style>
        /* ... CSS æ ·å¼ä¿æŒä¸å˜ ... */
        .body-section {
            flex: 1;
            display: flex;
            gap: 20px;
            overflow: hidden;
        }

        .add-tag-group {
            display: flex;
            margin-top: 10px;
            gap: 5px;
        }

            .add-tag-group button {
                background-color: #27AE60;
                border: none;
                color: white;
                border-radius: 4px;
                padding: 6px 12px;
                cursor: pointer;
            }

        .tag-list-panel li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
        }

            .tag-list-panel li.selected {
                border: 1px solid #3498DB;
                background-color: rgba(52, 152, 219, 0.2);
            }


        .delete-tag-btn {
            background: none;
            border: 1px solid #E74C3C;
            color: #E74C3C;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
        }

            .delete-tag-btn:hover {
                background-color: #E74C3C;
                color: white;
                opacity: 1;
            }

        .detail-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .process-panel {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

            .process-panel h4 {
                margin: 0;
                font-size: 16px;
                border-bottom: 1px solid rgba(255,255,255,0.2);
                padding-bottom: 4px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

        .window-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            .window-list li {
                padding: 4px 8px;
                margin-bottom: 2px;
                background-color: rgba(255,255,255,0.2);
                border-radius: 4px;
                font-size: 14px;
                white-space: nowrap; /* é¿å…æ¢è¡Œ */
                overflow: hidden; /* éšè—æº¢å‡ºéƒ¨åˆ† */
                text-overflow: ellipsis; /* æ˜¾ç¤ºçœç•¥å· */
            }

                .window-list li:hover {
                    background-color: rgba(255,255,255,0.3);
                }

        .process-label-select {
            background-color: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">è¿›ç¨‹ç®¡ç†</div>

        <div class="body-section">
            <div class="tag-list-panel">
                <h3>æ ‡ç­¾</h3>
                <ul id="tagList">
                </ul>
                <div class="add-tag-group">
                    <input type="text" id="newTagInput" placeholder="è¾“å…¥æ–°æ ‡ç­¾">
                    <button id="addTagBtn">æ·»åŠ </button>
                </div>
            </div>

            <div class="detail-panel" id="detailPanel">
                <p style="text-align: center; color: #ccc; padding-top: 50px;">è¯·é€‰æ‹©æ ‡ç­¾æˆ–ç­‰å¾…æ•°æ®åŠ è½½...</p>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å®šä¹‰
        const tagListEl = document.getElementById('tagList');
        const detailPanelEl = document.getElementById('detailPanel');
        const newTagInput = document.getElementById('newTagInput');
        const addTagBtn = document.getElementById('addTagBtn');

        let tags = []; // å­˜å‚¨ CategoryDetailDto å¯¹è±¡çš„æ•°ç»„
        let selectedTagIndex = null;
        let selectedTagName = null;

        /**
         * æ£€æŸ¥ Bridge å“åº”æ˜¯å¦æœ‰æ•ˆå¹¶æ›´æ–°æ ‡ç­¾æ•°æ®
         * @param {object} response - ä» C# Bridge æ”¶åˆ°çš„å“åº”
         * @returns {boolean} - æ•°æ®æ˜¯å¦æˆåŠŸæ›´æ–°
         */
        function updateTagsFromResponse(response) {
            if (response && response.tags && Array.isArray(response.tags)) {
                tags = response.tags;
                console.log(`[JS LOG] æ•°æ®æ›´æ–°æˆåŠŸã€‚æ–°æ ‡ç­¾æ•°é‡: ${tags.length}`);
                return true;
            }
            return false;
        }

        // ä»BridgeåŠ è½½æ ‡ç­¾æ•°æ®
        async function loadTagsData() {
            try {
                console.log("[JS LOG] ğŸ“¡ é€šè¿‡BridgeåŠ è½½æ ‡ç­¾æ•°æ®...");
                // ç¡®ä¿åç«¯è¿”å›çš„æ˜¯ { tags: [...] } ç»“æ„
                const response = await Bridge.send('getTagsData', null, true);

                if (response && response.tags && Array.isArray(response.tags)) { // ä¿®æ­£ï¼šä» response.tags è·å–æ•°ç»„
                    tags = response.tags;
                    console.log(`[JS LOG] âœ… åŠ è½½æˆåŠŸ: ${tags.length} ä¸ªæ ‡ç­¾`);
                } else {
                    throw new Error("C#è¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘ tags æ•°ç»„ã€‚");
                }

                // å°è¯•ä¿æŒå½“å‰é€‰ä¸­ï¼Œå¦åˆ™é€‰ä¸­ç¬¬ä¸€ä¸ª
                const currentTag = selectedTagName ? tags.find(t => t.name === selectedTagName) : null;
                if (!currentTag && tags.length > 0) {
                    selectedTagName = tags[0].name;
                } else if (!currentTag && tags.length === 0) {
                    selectedTagName = null;
                }

                renderTags();
                renderDetailPanel();
            } catch (e) {
                console.error('[JS ERROR] åŠ è½½æ ‡ç­¾æ•°æ®å¤±è´¥:', e);
                detailPanelEl.innerHTML = '<p style="color:red; text-align:center; padding-top: 50px;">æ— æ³•åŠ è½½æ ‡ç­¾æ•°æ®ã€‚</p>';
            }
        }


        // é€‰æ‹©æ ‡ç­¾
        async function selectTag(tagName) {
            try {
                if (selectedTagName === tagName) return; // é¿å…é‡å¤æ“ä½œ
                console.log("[JS LOG] æ­£åœ¨é€‰æ‹©æ ‡ç­¾:", tagName);

                // C# ç«¯çš„ selectTag å¯èƒ½æ˜¯ç”¨äºè®°å½•çŠ¶æ€
                try {
                    await Bridge.send('selectTag', { tagName }, true); // ä½¿ç”¨ Promise æ¨¡å¼
                } catch (bridgeError) {
                    console.warn('[JS WARNING] Bridgeé€‰æ‹©æ ‡ç­¾å‘é€å¤±è´¥:', bridgeError);
                }

                selectedTagName = tagName;
                selectedTagIndex = tags.findIndex(t => t.name === selectedTagName);
                renderTags();
                renderDetailPanel();

            } catch (error) {
                console.error('[JS ERROR] é€‰æ‹©æ ‡ç­¾å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æ ‡ç­¾
        async function addTag(newTagName) {
            newTagName = newTagName.trim();
            if (!newTagName) return alert("æ ‡ç­¾åä¸èƒ½ä¸ºç©º");

            try {
                console.log("[JS LOG] æ­£åœ¨è¯·æ±‚åç«¯æ·»åŠ æ ‡ç­¾:", newTagName);
                const response = await Bridge.send('addTag', { tagName: newTagName }, true);

                if (updateTagsFromResponse(response)) {
                    // æˆåŠŸåé€‰ä¸­æ–°æ·»åŠ çš„æ ‡ç­¾ï¼Œå¹¶æ¸²æŸ“
                    selectedTagName = newTagName;
                    renderTags();
                    renderDetailPanel();
                    newTagInput.value = '';
                    return;
                }
                throw new Error(response?.Error || "æ“ä½œå¤±è´¥ï¼Œä½†æœªæä¾›é”™è¯¯ä¿¡æ¯ã€‚");

            } catch (error) {
                console.error("[JS ERROR] æ·»åŠ æ ‡ç­¾å¤±è´¥:", error);
                alert("æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨ã€‚");
            }
        }


        // åˆ é™¤æ ‡ç­¾
        async function deleteTag(tagName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ ‡ç­¾ "${tagName}" å—ï¼Ÿè¯¥æ ‡ç­¾ä¸‹çš„è¿›ç¨‹å°†è¢«ç§»è‡³â€œæœªåˆ†ç±»â€ã€‚`)) return;

            try {
                console.log("[JS LOG] è¯·æ±‚åç«¯åˆ é™¤æ ‡ç­¾:", tagName);
                const response = await Bridge.send('deleteTag', { tagName }, true);

                if (updateTagsFromResponse(response)) {
                    // é‡æ–°é€‰æ‹©ç¬¬ä¸€ä¸ªæ ‡ç­¾ï¼ˆé€šå¸¸æ˜¯æœªåˆ†ç±»ï¼‰
                    selectedTagName = tags.length > 0 ? tags[0].name : null;
                    renderTags();
                    renderDetailPanel();
                    return;
                }
                throw new Error(response?.Error || "æ“ä½œå¤±è´¥ï¼Œä½†æœªæä¾›é”™è¯¯ä¿¡æ¯ã€‚");

            } catch (error) {
                console.error("[JS ERROR] åˆ é™¤æ ‡ç­¾å¤±è´¥:", error);
                alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
            }
        }


        // æ›´æ”¹è¿›ç¨‹æ ‡ç­¾
        async function changeTag(processName, oldTagName, newTagName) {
            try {
                if (oldTagName === newTagName) return;

                console.log(`[JS LOG] å‡†å¤‡æ›´æ”¹è¿›ç¨‹æ ‡ç­¾:`, { processName, oldTagName, newTagName });

                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç›¸ä¿¡åç«¯ä¼šæ‰§è¡Œæ•°æ®åº“æ“ä½œå¹¶è¿”å›æ–°çš„å®Œæ•´æ•°æ®
                const payload = { processName, newTagName };
                console.log('[JS LOG] å‘é€ç»™ Bridge çš„ payload:', payload);

                const response = await Bridge.send('changeTag', payload, true);

                console.log('[JS LOG] Bridge è¿”å›çš„æ•°æ®:', response);

                if (updateTagsFromResponse(response)) {
                    // æˆåŠŸåé‡æ–°æ¸²æŸ“ï¼Œä¿æŒå½“å‰é€‰ä¸­çš„æ ‡ç­¾ä¸å˜
                    renderTags();
                    renderDetailPanel();
                    return;
                }

                console.warn('[JS WARNING] Bridgeæ›´æ”¹è¿›ç¨‹æ ‡ç­¾å¤±è´¥æˆ–è¿”å›æ•°æ®æ— æ•ˆï¼Œå°è¯•é‡æ–°åŠ è½½æ•°æ®...');
                loadTagsData();

            } catch (error) {
                console.error('[JS ERROR] æ›´æ”¹è¿›ç¨‹æ ‡ç­¾å¤±è´¥:', error);
                alert('æ›´æ”¹è¿›ç¨‹æ ‡ç­¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }


        function renderTags() {
            console.log("[JS LOG] ğŸ¨ å¼€å§‹æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨...");
            tagListEl.innerHTML = '';

            const renderableTags = tags;

            if (renderableTags.length === 0) {
                tagListEl.innerHTML = '<p style="color:#aaa;">æš‚æ— æ ‡ç­¾</p>';
                return;
            }

            renderableTags.forEach((tag) => {
                const li = document.createElement('li');

                const tagText = document.createElement('span');
                // ç¡®ä¿ tag.processes å­˜åœ¨ï¼Œå¦åˆ™æ˜¾ç¤º 0
                const processCount = (tag.processes && Array.isArray(tag.processes)) ? tag.processes.length : 0;
                tagText.textContent = `${tag.name} (${processCount})`;
                li.appendChild(tagText);

                if (tag.name === selectedTagName) {
                    li.classList.add('selected');
                }

                li.onclick = () => {
                    selectTag(tag.name);
                };

                // æ ¸å¿ƒä¿®æ”¹: ç¦ç”¨ "æœªåˆ†ç±»" æ ‡ç­¾çš„åˆ é™¤æŒ‰é’®ï¼ˆé€šè¿‡ ID=1 æˆ–åç§°åˆ¤æ–­ï¼‰
                // å‡è®¾ ID=1 æ˜¯â€œæœªåˆ†ç±»â€
                const isUncategorized = tag.id === 1 || tag.name === "æœªåˆ†ç±»";

                if (!isUncategorized) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-tag-btn';
                    deleteBtn.textContent = 'åˆ é™¤';

                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ° li çš„ onclick
                        deleteTag(tag.name);
                    };
                    li.appendChild(deleteBtn);
                } else {
                    // å¦‚æœæ˜¯â€œæœªåˆ†ç±»â€æ ‡ç­¾ï¼Œæ·»åŠ ä¸€ä¸ªä¸å¯åˆ é™¤çš„æ ‡è®°
                    const span = document.createElement('span');
                    span.style.color = '#7f8c8d';
                    span.style.fontSize = '12px';
                    span.textContent = ' (ç³»ç»Ÿ)';
                    li.appendChild(span);
                }

                tagListEl.appendChild(li);
            });
            console.log("[JS LOG] ğŸ¨ æ ‡ç­¾åˆ—è¡¨æ¸²æŸ“å®Œæˆã€‚");
        }



        function renderDetailPanel() {
            console.log(`[JS LOG] ğŸ¨ å¼€å§‹æ¸²æŸ“è¯¦æƒ…é¢æ¿ï¼Œå½“å‰æ ‡ç­¾: ${selectedTagName}`);
            detailPanelEl.innerHTML = '';

            const tag = tags.find(t => t.name === selectedTagName);

            if (!tag) {
                detailPanelEl.innerHTML = '<p style="text-align: center; color: #ccc; padding-top: 50px;">è¯·é€‰æ‹©æ ‡ç­¾æˆ–æ ‡ç­¾åˆ—è¡¨ä¸ºç©ºã€‚</p>';
                return;
            }

            // æ£€æŸ¥è¿›ç¨‹åˆ—è¡¨æ˜¯å¦æœ‰æ•ˆ
            if (!tag.processes || tag.processes.length === 0) {
                detailPanelEl.innerHTML = `<p style="text-align: center; color: #ccc; padding-top: 50px;">æ ‡ç­¾ "${tag.name}" ä¸‹æš‚æ— è¿›ç¨‹æ•°æ®ã€‚</p>`;
                return;
            }

            tag.processes.forEach(proc => {
                const panel = document.createElement('div');
                panel.className = 'process-panel';

                const h4 = document.createElement('h4');
                h4.textContent = proc.ProcessName;


                const select = document.createElement('select');
                select.className = 'process-label-select';

                tags.forEach((t) => {
                    const option = document.createElement('option');
                    option.value = t.name;
                    option.textContent = t.name;

                    if (t.name === selectedTagName) {
                        option.selected = true;
                    }

                    select.appendChild(option);
                });

                select.addEventListener('change', function () {
                    const newTagName = this.value;
                    const oldTagName = selectedTagName;

                    changeTag(proc.ProcessName, oldTagName, newTagName);
                });

                h4.appendChild(select);
                panel.appendChild(h4);

                // æ¸²æŸ“çª—å£åˆ—è¡¨
                const ul = document.createElement('ul');
                ul.className = 'window-list';

                // ğŸŒŸ æ ¸å¿ƒä¿®å¤å°è¯•ï¼šå°† proc.windows (å°å†™) æ”¹å› proc.Windows (å¤§å†™)
                if (proc.Windows && Array.isArray(proc.Windows) && proc.Windows.length > 0) {
                    proc.Windows.forEach(win => {
                        const li = document.createElement('li');
                        li.textContent = win;
                        li.title = win; // é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå®Œæ•´çš„çª—å£æ ‡é¢˜
                        ul.appendChild(li);
                    });
                } else {
                    // **ã€DEBUG æç¤ºã€‘** å¦‚æœè¿™é‡Œä»ç„¶å¤±è´¥ï¼Œè¯·åœ¨ C# æ£€æŸ¥åºåˆ—åŒ–è®¾ç½®ï¼Œæˆ–åœ¨ JS æ§åˆ¶å°æ‰“å° proc å¯¹è±¡
                    console.warn(`[JS WARNING] è¿›ç¨‹ ${proc.ProcessName} ç¼ºå°‘çª—å£æ•°æ®ã€‚proc.Windows:`, proc.Windows);

                    const li = document.createElement('li');
                    li.textContent = '(æ— æ´»è·ƒçª—å£æˆ–çª—å£ä¿¡æ¯)';
                    li.style.color = '#7f8c8d';
                    li.style.backgroundColor = 'transparent';
                    ul.appendChild(li);
                }

                panel.appendChild(ul);
                detailPanelEl.appendChild(panel);
            });
        }

        // äº‹ä»¶ç»‘å®š
        addTagBtn.addEventListener('click', () => {
            addTag(newTagInput.value);
        });

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œä» C# åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            loadTagsData();
        });
    </script>

</body>
</html>