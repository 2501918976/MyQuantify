<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§„åˆ™å¼•æ“ - å…¨é€æ˜ç²¾è‡´ç‰ˆ</title>
    <style>
        :root {
            --mica-bg: rgba(255, 255, 255, 0.15);
            --mica-border: rgba(255, 255, 255, 0.25);
            --accent: #0078d4;
            --glass-blur: blur(30px) saturate(160%);
        }

        body {
            width: 1000px;
            height: 600px;
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
        }

        .container {
            width: 1000px;
            height: 600px;
            display: flex;
            padding: 20px;
            gap: 15px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--mica-border);
            border-radius: 12px;
        }

        /* --- é¢æ¿æ ·å¼ --- */
        .panel {
            background: var(--mica-bg);
            border: 1px solid var(--mica-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-header {
            padding: 12px;
            font-weight: 800;
            font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pending-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .pending-item {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            margin-bottom: 8px;
            font-size: 11px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: grab;
            transition: 0.2s;
        }

            .pending-item:hover {
                background: rgba(255,255,255,0.4);
                border-color: #fff;
            }

        /* --- ä¸»åŒºåŸŸ --- */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rule-table-header {
            display: grid;
            grid-template-columns: 130px 60px 160px 100px 90px 40px;
            gap: 8px;
            padding: 0 15px;
            font-size: 11px;
            font-weight: 700;
            color: rgba(0,0,0,0.4);
        }

        .rule-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 5px;
        }

            .rule-list.drag-over {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 12px;
            }

        .rule-row {
            display: grid;
            grid-template-columns: 130px 60px 160px 100px 90px 40px;
            gap: 8px;
            padding: 6px 12px;
            align-items: center;
            background: rgba(255,255,255,0.12);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        select, input {
            width: 100%;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 11px;
            background: rgba(255,255,255,0.1);
            outline: none;
            color: #1a1a1a;
        }

            select:focus, input:focus {
                background: rgba(255,255,255,0.5);
            }

        .btn {
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-ghost {
            background: rgba(255,255,255,0.15);
            color: #000;
            border: 1px solid var(--mica-border);
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-danger {
            background: none;
            color: #e81123;
            font-size: 14px;
            cursor: pointer;
            border: none;
            opacity: 0.4;
        }

            .btn-danger:hover {
                opacity: 1;
            }

        /* --- åˆ†ç±»ç®¡ç†å¼¹çª— --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            width: 200px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(25px) saturate(180%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .cat-item {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }

            .cat-item input {
                font-size: 10px;
                padding: 3px;
            }

        .empty-tip {
            text-align: center;
            color: rgba(0,0,0,0.2);
            font-size: 11px;
            margin-top: 100px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <aside class="sidebar panel">
            <div class="sidebar-header">
                <span>æ•è·é˜Ÿåˆ— (æœªåˆ†ç±»)</span>
                <span style="cursor:pointer; font-size:10px; color:var(--accent);" onclick="refreshCaptureList()">ğŸ”„ åˆ·æ–°</span>
            </div>
            <div class="pending-list" id="pendingList">
            </div>
        </aside>

        <main class="main-area">
            <div class="toolbar panel">
                <span style="font-weight: 800; font-size: 13px;">è§„åˆ™ç®¡ç†</span>
                <button class="btn btn-ghost" onclick="toggleModal(true)">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</button>
            </div>

            <div class="rule-table-header">
                <span>è¿›ç¨‹ç‰¹å¾</span><span>é€»è¾‘</span><span>çª—å£ç‰¹å¾</span><span>åŒ¹é…æ–¹æ³•</span><span>å½’å±åˆ†ç±»</span><span></span>
            </div>

            <div class="rule-list" id="ruleList" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
                <div class="empty-tip" id="emptyTip">æ‹–æ‹½å·¦ä¾§é¡¹åˆ°æ­¤å¤„</div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="catModal">
        <div class="modal-content">
            <h4 style="margin:0 0 12px 0; font-size:13px; text-align:center;">åˆ†ç±»æ ‡ç­¾</h4>
            <div id="catManagerList" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;">
            </div>
            <button class="btn btn-ghost" style="width:100%; margin-bottom:8px; font-size:10px;" onclick="addNewTag()">+ æ–°å¢</button>
            <button class="btn btn-primary" style="width:100%; font-size:10px;" onclick="toggleModal(false)">ç¡®å®š</button>
        </div>
    </div>

<script src="bridge.js"></script>
<script>
    let dragData = null;
    let cachedCategories = [];

    // ===== Bridge è°ƒç”¨ç»Ÿä¸€å°è£… =====
    async function callBridge(method, param = null) {
        // 1. å°è¯•ä»å½“å‰çª—å£ã€çˆ¶çª—å£ã€ç”šè‡³é¡¶çº§çª—å£è·å– bridge
        const bridge = window.chrome?.webview?.hostObjects?.bridge || 
                    window.parent?.chrome?.webview?.hostObjects?.bridge ||
                    window.top?.chrome?.webview?.hostObjects?.bridge;

        if (!bridge) {
            throw new Error("Bridge æœªå°±ç»ªï¼Œè¯·ç¨åé‡è¯•");
        }

        try {
            if (param !== null) {
                return await bridge[method](JSON.stringify(param));
            } else {
                return await bridge[method]();
            }
        } catch (e) {
            // å¦‚æœæŠ¥é”™â€œæ‰¾ä¸åˆ°å…ƒç´ â€ï¼Œé€šå¸¸æ˜¯ç”±äºå¼•ç”¨å¤±æ•ˆï¼Œæ‰“å°æ›´æ¸…æ™°çš„æ—¥å¿—
            console.error(`è°ƒç”¨ ${method} å¤±è´¥:`, e);
            throw e;
        }
    }

    // ===== åˆå§‹åŒ– =====
    window.onload = () => {
        setTimeout(() => {
            reloadAll().catch(err => console.error(err));
        }, 200);
    };

    async function reloadAll() {
        await refreshCategories();
        await refreshRules();
        await refreshCaptureList();
    }

    // ===== æœªåˆ†ç±»æ´»åŠ¨ =====
    async function refreshCaptureList() {
        const json = await callBridge("è·å–æœªåˆ†ç±»çš„æ´»åŠ¨");
        const list = JSON.parse(json);

        const container = document.getElementById("pendingList");
        container.innerHTML = list.length
            ? list.map(item => `
                <div class="pending-item"
                     draggable="true"
                     ondragstart="onDragStart(event,
                        '${item.ProcessName.replace(/'/g, "\\'")}',
                        '${(item.WindowTitle || "").replace(/'/g, "\\'")}')">
                    <div style="font-weight:700">${item.ProcessName}</div>
                    <div style="opacity:.6; white-space:nowrap; overflow:hidden;">
                        ${item.WindowTitle || "æ— æ ‡é¢˜"}
                    </div>
                </div>
            `).join("")
            : `<div class="empty-tip">æš‚æ— æœªåˆ†ç±»æ´»åŠ¨</div>`;
    }

    // ===== åˆ†ç±»ç®¡ç† =====
    async function refreshCategories() {
        const json = await callBridge("è·å–æ‰€æœ‰åˆ†ç±»");
        cachedCategories = JSON.parse(json);

        const container = document.getElementById("catManagerList");
        container.innerHTML = cachedCategories.map(cat => `
            <div class="cat-item">
                <input value="${cat.CategoryName}"
                       onchange="updateCategory(${cat.Id}, this.value)">
                <button class="btn-danger"
                        onclick="deleteCategory(${cat.Id})">Ã—</button>
            </div>
        `).join("");
    }

    async function addNewTag() {
        await callBridge("æ–°å¢ä¸€ä¸ªåˆ†ç±»", {
            CategoryName: "æ–°åˆ†ç±»",
            ColorCode: "#0078d4"
        });
        await refreshCategories();
        await refreshRules();
    }

    async function updateCategory(id, name) {
        await callBridge("æ–°å¢ä¿®æ”¹åˆ†ç±»", {
            Id: id,
            CategoryName: name
        });
        await refreshCategories();
        await refreshRules();
    }

    async function deleteCategory(id) {
        if (!confirm("åˆ é™¤åˆ†ç±»å°†åŒæ—¶åˆ é™¤å…¶ä¸‹æ‰€æœ‰è§„åˆ™ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        await callBridge("æ–°å¢åˆ é™¤åˆ†ç±»", { Id: id });
        await reloadAll();
    }

    // ===== è§„åˆ™ç®¡ç† =====
    async function refreshRules() {
        const list = document.getElementById("ruleList");
        list.innerHTML = "";

        let hasRules = false;

        cachedCategories.forEach(cat => {
            (cat.CategoryRules || []).forEach(rule => {
                hasRules = true;
                appendRuleRow(rule);
            });
        });

        if (!hasRules) {
            list.innerHTML = `<div class="empty-tip" id="emptyTip">æ‹–æ‹½å·¦ä¾§é¡¹åˆ°æ­¤å¤„</div>`;
        }
    }

    function appendRuleRow(rule) {
        document.getElementById("emptyTip")?.remove();

        const row = document.createElement("div");
        row.className = "rule-row";

        row.innerHTML = `
            <input value="${rule.ProcessName}"
                   onchange="saveRule(${rule.Id}, this)">
            <select onchange="saveRule(${rule.Id}, this)">
                <option value="0" ${rule.LogicType === 0 ? "selected" : ""}>AND</option>
                <option value="1" ${rule.LogicType === 1 ? "selected" : ""}>OR</option>
                <option value="2" ${rule.LogicType === 2 ? "selected" : ""}>NOT</option>
            </select>
            <input value="${rule.TitleMatchValue || ""}"
                   onchange="saveRule(${rule.Id}, this)">
            <select onchange="saveRule(${rule.Id}, this)">
                <option value="0" ${rule.TitleMatchType === 0 ? "selected" : ""}>å…¨å­—</option>
                <option value="1" ${rule.TitleMatchType === 1 ? "selected" : ""}>åŒ…å«</option>
                <option value="2" ${rule.TitleMatchType === 2 ? "selected" : ""}>æ­£åˆ™</option>
            </select>
            <select onchange="saveRule(${rule.Id}, this)">
                ${cachedCategories.map(c =>
                    `<option value="${c.Id}" ${c.Id === rule.CategoryId ? "selected" : ""}>
                        ${c.CategoryName}
                    </option>`
                ).join("")}
            </select>
            <button class="btn-danger" onclick="deleteRule(${rule.Id})">Ã—</button>
        `;

        document.getElementById("ruleList").appendChild(row);
    }

    async function saveRule(id, el) {
        const row = el.closest(".rule-row");
        const inputs = row.querySelectorAll("input");
        const selects = row.querySelectorAll("select");

        await callBridge("ä¿®æ”¹ä¸€ä¸ªè§„åˆ™", {
            Id: id,
            ProcessName: inputs[0].value,
            LogicType: Number(selects[0].value),
            TitleMatchValue: inputs[1].value,
            TitleMatchType: Number(selects[1].value),
            CategoryId: Number(selects[2].value),
            IsEnabled: true
        });
    }

    async function deleteRule(id) {
        await callBridge("åˆ é™¤ä¸€ä¸ªè§„åˆ™", { Id: id });
        await reloadAll();
    }

    // ===== æ‹–æ‹½ =====
    function onDragStart(e, proc, title) {
        dragData = { proc, title };
    }

    function onDragOver(e) {
        e.preventDefault();
        document.getElementById("ruleList").classList.add("drag-over");
    }

    function onDragLeave() {
        document.getElementById("ruleList").classList.remove("drag-over");
    }

    async function onDrop(e) {
        e.preventDefault();
        document.getElementById("ruleList").classList.remove("drag-over");

        if (!dragData) return;
        if (cachedCategories.length === 0) {
            alert("è¯·å…ˆåˆ›å»ºåˆ†ç±»");
            return;
        }

        await callBridge("æ–°å¢ä¸€ä¸ªè§„åˆ™", {
            ProcessName: dragData.proc,
            TitleMatchValue: dragData.title,
            CategoryId: cachedCategories[0].Id,
            LogicType: 0,
            TitleMatchType: 1,
            IsEnabled: true
        });

        dragData = null;
        await reloadAll();
    }

    function toggleModal(show) {
        document.getElementById("catModal").style.display = show ? "flex" : "none";
    }
</script>


</body>
</html>